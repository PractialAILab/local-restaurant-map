<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Better Source - Restaurant Supply Insight</title>
  
  <!-- Favicon -->
  <link rel="icon" type="image/png" href="/assets/icons/BS32x32logo.png">
  
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  
  <!-- jQuery -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      height: 100vh;
      overflow: hidden;
      display: flex;
    }
    
    /* Sidebar Layout */
    #sidebar {
      width: 400px;
      height: 100vh;
      background: #f8f9fa;
      overflow-y: auto;
      border-right: 2px solid #dee2e6;
      z-index: 100;
    }
    
    #map-container {
      flex: 1;
      height: 100vh;
      position: relative;
    }
    
    #map {
      width: 100%;
      height: 100%;
    }
    
    /* Header in Sidebar */
    #header {
      background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
      color: white;
      padding: 20px;
      text-align: center;
    }
    
    #header img {
      height: 40px;
      vertical-align: middle;
      margin-right: 10px;
    }
    
    #header h1 {
      font-size: 1.3em;
      color: white;
      display: inline;
      vertical-align: middle;
    }
    
    /* Navigation */
    #header nav {
      margin-top: 15px;
      display: flex;
      justify-content: center;
      gap: 20px;
      flex-wrap: wrap;
    }
    
    #header nav a {
      color: white;
      text-decoration: none;
      font-size: 0.9em;
      font-weight: 500;
      transition: opacity 0.3s;
    }
    
    #header nav a:hover {
      opacity: 0.7;
      text-decoration: underline;
    }
    
    /* Search Box in Sidebar */
    #search-container {
      padding: 15px;
      background: white;
      border-bottom: 1px solid #dee2e6;
    }
    
    #searchInput {
      width: 100%;
      padding: 10px 15px;
      border: 2px solid #2ecc71;
      border-radius: 25px;
      font-size: 0.95em;
    }
    
    #searchInput:focus {
      outline: none;
      border-color: #27ae60;
    }
    
    /* Restaurant List */
    #restaurant-list {
      padding: 10px;
    }
    
    .restaurant-card {
      background: white;
      margin-bottom: 15px;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      cursor: pointer;
      transition: all 0.3s ease;
      border-left: 4px solid #ddd;
    }
    
    .restaurant-card:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      transform: translateY(-2px);
    }
    
    .restaurant-card.selected {
      border-left-color: #2ecc71;
      background: #f0f9f4;
    }
    
    /* Ranking Badge */
    .ranking-badge {
      display: inline-block;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      margin-right: 10px;
      vertical-align: middle;
      border: 3px solid #fff !important;
      box-shadow: 0 2px 8px rgba(0,0,0,0.4) !important;
      flex-shrink: 0;
      position: relative;
    }
    
    /* Force colors with maximum specificity */
    span.ranking-badge.ranking-high {
      background-color: #2ecc71 !important;
      background: #2ecc71 !important;
    }
    
    span.ranking-badge.ranking-medium {
      background-color: #f39c12 !important;
      background: #f39c12 !important;
    }
    
    span.ranking-badge.ranking-basic {
      background-color: #e74c3c !important;
      background: #e74c3c !important;
    }
    
    .restaurant-card h3 {
      font-size: 1.1em;
      color: #2c3e50;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
    }
    
    .restaurant-card p {
      margin: 5px 0;
      color: #555;
      font-size: 0.9em;
    }
    
    .restaurant-card p strong {
      color: #2c3e50;
    }
    
    /* Category Badges */
    .category-container {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
    }
    
    .category-badge {
      display: inline-block;
      padding: 3px 8px;
      color: white;
      border-radius: 12px;
      font-size: 0.75em;
      font-weight: bold;
    }
    
    .category-badge.local-yes {
      background: #2ecc71;
    }
    
    .category-badge.local-no {
      background: #e74c3c;
    }
    
    /* Coupon Indicator */
    .coupon-indicator {
      display: inline-block;
      padding: 4px 10px;
      background: #730C99;
      color: white;
      border-radius: 15px;
      font-size: 0.8em;
      font-weight: bold;
      margin-top: 8px;
      cursor: pointer;
      transition: background 0.3s;
    }
    
    .coupon-indicator:hover {
      background: #5a0a7a;
    }
    
    .coupon-link {
      color: white;
      text-decoration: none;
      font-weight: bold;
    }
    
    .coupon-link:hover {
      text-decoration: underline;
    }
    
    /* Coupon Dropdown Card */
    .coupon-dropdown {
      display: none;
      margin-top: 10px;
      padding: 15px;
      background: #f8f3ff;
      border: 2px solid #730C99;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(115, 12, 153, 0.2);
    }
    
    .coupon-dropdown.active {
      display: block;
      animation: slideDown 0.3s ease;
    }
    
    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .coupon-dropdown-content {
      color: #333;
      line-height: 1.6;
      font-size: 0.9em;
    }
    
    .coupon-dropdown-header {
      font-weight: bold;
      color: #730C99;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    /* Phone and Hours */
    .contact-info {
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid #ecf0f1;
    }
    
    .contact-info a {
      color: #3498db;
      text-decoration: none;
    }
    
    .contact-info a:hover {
      text-decoration: underline;
    }
    
    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #7f8c8d;
    }
    
    .empty-state i {
      font-size: 3em;
      margin-bottom: 15px;
      opacity: 0.5;
    }
    
    /* FOR RESTAURANTS BUTTON */
    #restaurantCTA {
      position: absolute;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
    }
    
    #restaurantCTA a {
      background: #2ecc71;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      text-decoration: none;
      font-weight: bold;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      display: inline-block;
      font-size: 0.9em;
      transition: all 0.3s ease;
    }
    
    #restaurantCTA a:hover {
      background: #27ae60;
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.3);
    }
    
    /* Loading State */
    .loading {
      text-align: center;
      padding: 40px;
      color: #7f8c8d;
    }
    
    .loading i {
      font-size: 2em;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Mobile Responsive */
    @media (max-width: 768px) {
      body {
        flex-direction: column;
      }
      
      #sidebar {
        width: 100%;
        height: 50vh;
        border-right: none;
        border-bottom: 2px solid #dee2e6;
      }
      
      #map-container {
        height: 50vh;
      }
      
      #header h1 {
        font-size: 1.1em;
      }
      
      .restaurant-card {
        padding: 12px;
      }
    }
  </style>
</head>
<body>
  
  <!-- Sidebar -->
  <div id="sidebar">
    <!-- Header -->
    <div id="header">
      <img src="/assets/icons/BS32x32logo.png" alt="Better Source Logo">
      <h1>Better Source</h1>
      <nav>
        <a href="index.html">Home</a>
        <a href="about.html">About</a>
        <a href="for-restaurants.html">For Restaurants</a>
        <a href="contact.html">Contact</a>
      </nav>
    </div>
    
    <!-- Search -->
    <div id="search-container">
      <input type="text" id="searchInput" placeholder="üîç Search restaurants...">
    </div>
    
    <!-- Restaurant List -->
    <div id="restaurant-list">
      <div class="loading">
        <i class="fa fa-spinner"></i>
        <p>Loading restaurants...</p>
      </div>
    </div>
  </div>
  
  <!-- Map Container -->
  <div id="map-container">
    <div id="map"></div>
    
    <!-- FOR RESTAURANTS BUTTON -->
    <div id="restaurantCTA">
      <a href="restaurant-application.html">
        üå± List Your Restaurant
      </a>
    </div>
  </div>
  
  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
  <!-- Papa Parse for CSV -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  
  <script>
    // Wait for all libraries to load
    window.addEventListener('load', function() {
      initMap();
    });
    
    function initMap() {
      // Initialize the map
      var map = L.map('map').setView([39.7392, -104.9903], 11);
    
      // Add OpenStreetMap tiles
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        maxZoom: 19
      }).addTo(map);
      
      // Store all restaurants and markers
      var allRestaurants = [];
      var markersLayer = L.layerGroup().addTo(map);
      var geocodingQueue = [];
      var geocodingInProgress = false;
      
      // Category labels for display
      var categoryLabels = {
        beef: 'Beef',
        pork: 'Pork',
        chicken: 'Chicken',
        seafood: 'Seafood',
        breads: 'Breads',
        produce: 'Produce',
        dairy: 'Dairy',
        desserts: 'Desserts',
        appetizers: 'Appetizers'
      };
      
      // GEOCODING FUNCTION - NEW
      function geocodeAddress(address, callback) {
        // Clean up address for better geocoding
        var cleanAddress = address;
        
        // Add ", Colorado" if not present
        if (!address.toLowerCase().includes('colorado') && !address.toLowerCase().includes(', co')) {
          cleanAddress = address + ', Colorado';
        }
        
        var url = 'https://nominatim.openstreetmap.org/search?format=json&q=' + encodeURIComponent(cleanAddress);
        
        $.ajax({
          url: url,
          method: 'GET',
          headers: {
            'User-Agent': 'BetterSourceRestaurantMap/1.0'
          },
          success: function(data) {
            if (data && data.length > 0) {
              callback({
                lat: parseFloat(data[0].lat),
                lon: parseFloat(data[0].lon),
                success: true
              });
            } else {
              console.warn('No geocoding results for:', address);
              callback({ success: false });
            }
          },
          error: function() {
            console.error('Geocoding error for:', address);
            callback({ success: false });
          }
        });
      }
      
      // PROCESS GEOCODING QUEUE - NEW
      function processGeocodingQueue() {
        if (geocodingQueue.length === 0) {
          geocodingInProgress = false;
          renderAllRestaurants();
          return;
        }
        
        geocodingInProgress = true;
        var item = geocodingQueue.shift();
        
        geocodeAddress(item.address, function(result) {
          if (result.success) {
            item.restaurant.lat = result.lat;
            item.restaurant.lon = result.lon;
            console.log('‚úÖ Geocoded:', item.restaurant.name, '‚Üí', result.lat, result.lon);
          } else {
            console.warn('‚ùå Failed to geocode:', item.restaurant.name);
          }
          
          // Wait 1 second between requests (Nominatim rate limit)
          setTimeout(processGeocodingQueue, 1000);
        });
      }
      
      // Function to calculate percentage from local_score
      function calculatePercentage(restaurant) {
        // Try to get local_score (column S)
        var score = parseFloat(restaurant.local_score) || 0;
        
        // Calculate percentage: (score / 9 categories) * 100
        var percentage = Math.round((score / 9) * 100);
        
        return percentage;
      }
      
      // Function to get ranking badge HTML based on percentage
      function getRankingBadge(restaurant) {
        var percentage = calculatePercentage(restaurant);
        
        // Determine badge class based on percentage
        var badgeClass = 'ranking-basic';
        var badgeText = 'Basic';
        
        if (percentage >= 75) {
          badgeClass = 'ranking-high';
          badgeText = 'Excellent';
        } else if (percentage >= 50) {
          badgeClass = 'ranking-medium';
          badgeText = 'Good';
        }
        
        var title = badgeText + ' Local Sourcing (' + percentage + '% of menu is local)';
        
        return '<span class="ranking-badge ' + badgeClass + '" title="' + title + '"></span>';
      }
      
      // Function to get category badges HTML
      function getCategoryBadges(restaurant) {
        var badges = '';
        var categories = ['beef', 'pork', 'chicken', 'seafood', 'breads', 'produce', 'dairy', 'desserts', 'appetizers'];
        
        categories.forEach(function(cat) {
          // Check if category has a value (Yes or No)
          if (restaurant[cat]) {
            var value = restaurant[cat].toLowerCase();
            if (value === 'yes') {
              badges += '<span class="category-badge local-yes">' + categoryLabels[cat] + '</span>';
            } else if (value === 'no') {
              badges += '<span class="category-badge local-no">' + categoryLabels[cat] + '</span>';
            }
          }
        });
        
        return badges ? '<div class="category-container">' + badges + '</div>' : '';
      }
      
      // Function to create restaurant card HTML
      function createRestaurantCard(restaurant, index) {
        var rankingBadge = getRankingBadge(restaurant);
        var categoryBadges = getCategoryBadges(restaurant);
        
        var html = '<div class="restaurant-card" data-index="' + index + '">';
        html += '<h3>' + rankingBadge + restaurant.name + '</h3>';
        html += '<p><strong>üìç</strong> ' + restaurant.address + '</p>';
        
        // Contact Info
        if (restaurant.phone || restaurant.hours) {
          html += '<div class="contact-info">';
          if (restaurant.phone) {
            html += '<p><strong>üìû</strong> <a href="tel:' + restaurant.phone.replace(/[^0-9]/g, '') + '">' + restaurant.phone + '</a></p>';
          }
          if (restaurant.hours) {
            html += '<p><strong>üïí</strong> ' + restaurant.hours + '</p>';
          }
          html += '</div>';
        }
        
        // Category badges
        html += categoryBadges;
        
        // Coupon indicator with dropdown (using coupon_text instead of direct_image_url)
        if (restaurant.subscription_tier === 'premium' && restaurant.coupon_text && restaurant.coupon_text.trim() !== '') {
          html += '<div class="coupon-indicator" onclick="toggleCoupon(event, ' + index + ')">üí∞ Special Offer - Click to View</div>';
          html += '<div class="coupon-dropdown" id="coupon-' + index + '">';
          html += '<div class="coupon-dropdown-header">üéâ Special Offer:</div>';
          html += '<div class="coupon-dropdown-content">' + restaurant.coupon_text + '</div>';
          html += '</div>';
        }
        
        html += '</div>';
        return html;
      }
      
      // RENDER ALL RESTAURANTS - NEW
      function renderAllRestaurants() {
        // Update loading message
        $('.loading p').text('Rendering ' + allRestaurants.length + ' restaurants...');
        
        // Clear restaurant list and markers
        $('#restaurant-list').empty();
        markersLayer.clearLayers();
        
        var bounds = [];
        
        allRestaurants.forEach(function(restaurantObj, index) {
          var restaurant = restaurantObj.data;
          
          // Only render if we have coordinates
          if (restaurantObj.lat && restaurantObj.lon) {
            // Create marker
            var marker = L.marker([restaurantObj.lat, restaurantObj.lon]).addTo(markersLayer);
            restaurantObj.marker = marker;
            
            // Create popup
            var rankingBadge = getRankingBadge(restaurant);
            
            var popupContent = '<div style="min-width: 200px;">';
            popupContent += '<h3 style="margin-bottom: 8px; display: flex; align-items: center;">' + rankingBadge + restaurant.name + '</h3>';
            popupContent += '<p style="margin: 4px 0;"><strong>üìç</strong> ' + restaurant.address + '</p>';
            if (restaurant.phone) {
              popupContent += '<p style="margin: 4px 0;"><strong>üìû</strong> ' + restaurant.phone + '</p>';
            }
            popupContent += '</div>';
            
            marker.bindPopup(popupContent);
            
            // Add to sidebar
            var cardHtml = createRestaurantCard(restaurant, index);
            $('#restaurant-list').append(cardHtml);
            
            bounds.push([restaurantObj.lat, restaurantObj.lon]);
          }
        });
        
        // Fit map to show all markers
        if (bounds.length > 0) {
          var group = new L.featureGroup(allRestaurants.map(r => r.marker).filter(m => m));
          map.fitBounds(group.getBounds(), { padding: [50, 50] });
        }
        
        console.log('‚úÖ Rendered', allRestaurants.length, 'restaurants');
      }
      
      // Load CSV with cache-busting to force reload
      var csvUrl = '/assets/data/stores.csv?v=' + new Date().getTime();
      
      Papa.parse(csvUrl, {
        download: true,
        header: true,
        skipEmptyLines: 'greedy',
        delimiter: ',',
        newline: '',
        quoteChar: '"',
        escapeChar: '"',
        transformHeader: function(header) {
          return header.trim();
        },
        complete: function(results) {
          console.log('CSV loaded successfully');
          console.log('Total restaurants:', results.data.length);
          console.log('Columns:', results.meta.fields);
          
          if (results.data.length === 0) {
            $('#restaurant-list').html('<div class="empty-state"><i class="fa fa-exclamation-circle"></i><p>No restaurants found.</p></div>');
            return;
          }
          
          // Process each restaurant
          results.data.forEach(function(restaurant, index) {
            // Skip if missing required name
            if (!restaurant.name || !restaurant.address) {
              console.warn('Skipping entry - missing name or address');
              return;
            }
            
            // Check if lat/lon are already present and valid
            var hasValidCoords = restaurant.lat && restaurant.lon && 
                                !isNaN(parseFloat(restaurant.lat)) && 
                                !isNaN(parseFloat(restaurant.lon));
            
            var restaurantObj = {
              data: restaurant,
              lat: null,
              lon: null,
              marker: null
            };
            
            if (hasValidCoords) {
              // Use existing coordinates
              restaurantObj.lat = parseFloat(restaurant.lat);
              restaurantObj.lon = parseFloat(restaurant.lon);
              allRestaurants.push(restaurantObj);
              console.log('‚úÖ Using existing coords for:', restaurant.name);
            } else if (restaurant.address) {
              // Need to geocode
              allRestaurants.push(restaurantObj);
              console.log('üîç Queuing geocoding for:', restaurant.name);
              geocodingQueue.push({
                restaurant: restaurantObj,
                address: restaurant.address
              });
            }
          });
          
          if (geocodingQueue.length > 0) {
            $('.loading p').text('Geocoding ' + geocodingQueue.length + ' addresses...');
            processGeocodingQueue();
          } else {
            renderAllRestaurants();
          }
        },
        error: function(error) {
          console.error('Error parsing CSV:', error);
          $('#restaurant-list').html('<div class="empty-state"><i class="fa fa-exclamation-circle"></i><p>Error loading restaurant data.</p></div>');
        }
      });
      
      // Handle restaurant card clicks
      $(document).on('click', '.restaurant-card', function() {
        var index = $(this).data('index');
        var restaurant = allRestaurants[index];
        
        // Update selected state
        $('.restaurant-card').removeClass('selected');
        $(this).addClass('selected');
        
        // Zoom to marker and open popup
        map.setView([restaurant.lat, restaurant.lon], 15);
        if (restaurant.marker) {
          restaurant.marker.openPopup();
        }
        
        // Scroll card into view if needed
        $(this)[0].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      });
      
      // Search functionality
      $('#searchInput').on('input', function() {
        var searchTerm = $(this).val().toLowerCase();
        
        if (searchTerm.length === 0) {
          // Show all restaurants
          $('.restaurant-card').show();
          return;
        }
        
        // Filter restaurants
        $('.restaurant-card').each(function() {
          var index = $(this).data('index');
          var restaurant = allRestaurants[index].data;
          
          // Build searchable text
          var searchable = (
            restaurant.name.toLowerCase() + ' ' +
            restaurant.address.toLowerCase() + ' ' +
            (restaurant.products || '').toLowerCase() + ' ' +
            (restaurant.phone || '').toLowerCase()
          );
          
          // Add category names to search
          var categories = ['beef', 'pork', 'chicken', 'seafood', 'breads', 'produce', 'dairy', 'desserts', 'appetizers'];
          categories.forEach(function(cat) {
            if (restaurant[cat] && restaurant[cat].toLowerCase() === 'yes') {
              searchable += ' ' + categoryLabels[cat].toLowerCase();
            }
          });
          
          if (searchable.includes(searchTerm)) {
            $(this).show();
          } else {
            $(this).hide();
          }
        });
      });
    } // End of initMap function
    
    // Toggle coupon dropdown function (global scope)
    function toggleCoupon(event, index) {
      event.stopPropagation(); // Prevent card click event
      
      var dropdown = $('#coupon-' + index);
      
      // Close all other dropdowns
      $('.coupon-dropdown').not(dropdown).removeClass('active');
      
      // Toggle this dropdown
      dropdown.toggleClass('active');
    }
  </script>
</body>
</html>
